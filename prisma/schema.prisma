generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String                  @id @default(cuid())
  name             String?
  email            String                  @unique
  emailVerified    Boolean                 @default(false)
  image            String?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  discordId        String?                 @unique
  discordTag       String?
  role             String?                 @default("user")
  banned           Boolean?                @default(false)
  banReason        String?
  banExpires       DateTime?
  username         String?                 @unique
  displayUsername  String?
  twoFactorEnabled Boolean                 @default(false)
  accounts         Account[]
  decks            Deck[]
  profile          Profile?
  sessions         Session[]
  player1Matches   TournamentMatch[]       @relation("Player1Matches")
  player2Matches   TournamentMatch[]       @relation("Player2Matches")
  winnerMatches    TournamentMatch[]       @relation("WinnerMatches")
  tournaments      TournamentParticipant[]
  twoFactors       TwoFactor[]

  @@map("users")
}

model Session {
  id             String   @id @default(cuid())
  expiresAt      DateTime
  token          String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?
  userAgent      String?
  userId         String
  impersonatedBy String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("two_factors")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verifications")
}

model Profile {
  id             String          @id @default(cuid())
  userId         String          @unique
  bladerName     String?
  favoriteType   BeyType?
  experience     ExperienceLevel @default(BEGINNER)
  bio            String?
  wins           Int             @default(0)
  losses         Int             @default(0)
  tournamentWins Int             @default(0)
  twitterHandle  String?
  tiktokHandle   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Part {
  id           String     @id @default(cuid())
  externalId   String     @unique
  name         String
  nameJp       String?
  type         PartType
  beyType      BeyType?
  weight       Float?
  attack       String?
  defense      String?
  stamina      String?
  burst        String?
  dash         String?
  height       Int?
  protrusions  Int?
  gearRatio    String?
  shaftWidth   String?
  tipType      String?
  releaseDate  DateTime?
  imageUrl     String?
  rarity       String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  beyBits      Beyblade[] @relation("BeyBitRelation")
  beyBlades    Beyblade[] @relation("BeyBladeRelation")
  beyRatchets  Beyblade[] @relation("BeyRatchetRelation")
  deckBits     DeckBey[]  @relation("BitRelation")
  deckBlades   DeckBey[]  @relation("BladeRelation")
  deckRatchets DeckBey[]  @relation("RatchetRelation")

  @@index([type])
  @@index([beyType])
  @@map("parts")
}

model Beyblade {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  nameEn       String?
  nameFr       String?
  bladeId      String
  ratchetId    String
  bitId        String
  beyType      BeyType?
  totalAttack  Int?
  totalDefense Int?
  totalStamina Int?
  totalBurst   Int?
  totalDash    Int?
  totalWeight  Float?
  imageUrl     String?
  productId    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  bit          Part     @relation("BeyBitRelation", fields: [bitId], references: [id])
  blade        Part     @relation("BeyBladeRelation", fields: [bladeId], references: [id])
  product      Product? @relation(fields: [productId], references: [id])
  ratchet      Part     @relation("BeyRatchetRelation", fields: [ratchetId], references: [id])

  @@index([beyType])
  @@map("beyblades")
}

model Deck {
  id                     String                  @id @default(cuid())
  name                   String
  isActive               Boolean                 @default(false)
  userId                 String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  beys                   DeckBey[]
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tournamentParticipants TournamentParticipant[]

  @@index([userId])
  @@map("decks")
}

model DeckBey {
  id        String  @id @default(cuid())
  position  Int
  nickname  String?
  deckId    String
  bladeId   String
  ratchetId String
  bitId     String
  bit       Part    @relation("BitRelation", fields: [bitId], references: [id])
  blade     Part    @relation("BladeRelation", fields: [bladeId], references: [id])
  deck      Deck    @relation(fields: [deckId], references: [id], onDelete: Cascade)
  ratchet   Part    @relation("RatchetRelation", fields: [ratchetId], references: [id])

  @@unique([deckId, position])
  @@index([deckId])
  @@map("deck_beys")
}

model Tournament {
  id                    String                  @id @default(cuid())
  name                  String
  description           String?
  date                  DateTime
  location              String?
  format                String                  @default("3on3 Double Elimination")
  maxPlayers            Int                     @default(64)
  challongeId           String?                 @unique
  challongeUrl          String?
  challongeState        String?
  registrationStart     DateTime?
  registrationEnd       DateTime?
  announcementMessageId String?
  channelId             String?
  status                TournamentStatus        @default(UPCOMING)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  matches               TournamentMatch[]
  participants          TournamentParticipant[]

  @@map("tournaments")
}

model TournamentParticipant {
  id                     String     @id @default(cuid())
  tournamentId           String
  userId                 String
  challongeParticipantId String?
  deckId                 String?
  checkedIn              Boolean    @default(false)
  seed                   Int?
  finalPlacement         Int?
  wins                   Int        @default(0)
  losses                 Int        @default(0)
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt
  deck                   Deck?      @relation(fields: [deckId], references: [id])
  tournament             Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user                   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, userId])
  @@map("tournament_participants")
}

model TournamentMatch {
  id               String     @id @default(cuid())
  tournamentId     String
  challongeMatchId String?
  round            Int
  player1Id        String?
  player2Id        String?
  winnerId         String?
  score            String?
  state            String     @default("pending")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  player1          User?      @relation("Player1Matches", fields: [player1Id], references: [id])
  player2          User?      @relation("Player2Matches", fields: [player2Id], references: [id])
  tournament       Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  winner           User?      @relation("WinnerMatches", fields: [winnerId], references: [id])

  @@unique([tournamentId, challongeMatchId])
  @@index([tournamentId])
  @@map("tournament_matches")
}

model StaffMember {
  id           String   @id @default(cuid())
  name         String
  role         String
  teamId       String
  imageUrl     String?
  discordId    String?
  displayIndex Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("staff_members")
}

model ContentBlock {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String?
  type      String   @default("text")
  content   String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("content_blocks")
}

model Product {
  id            String      @id @default(cuid())
  code          String      @unique
  name          String
  nameEn        String?
  nameFr        String?
  description   String?
  productType   ProductType
  productLine   ProductLine
  price         Int?
  releaseDate   DateTime?
  isLimited     Boolean     @default(false)
  limitedNote   String?
  imageUrl      String?
  productUrl    String?
  shopUrl       String?
  includedParts String[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  beyblades     Beyblade[]

  @@index([productLine])
  @@index([productType])
  @@map("products")
}

model BotCommand {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String
  response     String
  enabled      Boolean  @default(true)
  aliases      String[] @default([])
  cooldown     Int      @default(0)
  allowedRoles String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("bot_commands")
}

model DiscordRole {
  id          String   @id
  name        String
  color       String
  position    Int
  icon        String?
  permissions String
  managed     Boolean  @default(false)
  hoist       Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  @@map("discord_roles")
}

enum BeyType {
  ATTACK
  DEFENSE
  STAMINA
  BALANCE
}

enum PartType {
  BLADE
  RATCHET
  BIT
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  LEGEND
}

enum TournamentStatus {
  UPCOMING
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  CHECKIN
  UNDERWAY
  COMPLETE
  CANCELLED
}

enum ProductType {
  STARTER
  BOOSTER
  RANDOM_BOOSTER
  SET
  DOUBLE_STARTER
  TOOL
  COLOR_CHOICE
}

enum ProductLine {
  BX
  UX
  CX
}
